#!/bin/bash

# Use defaults from environment if set
HYPRMCSR_PROFILE="${HYPRMCSR_PROFILE:-}"
PROFILE="${PROFILE:-}"

usage() {
  cat << 'EOF'
Usage: hyprmcsr [-h HYPRMCSR_PROFILE] [-p PROFILE] <command> [args...]

Commands:
  init [--base-profile <name>]
                              Initialize hyprmcsr and create config files
                              Profile name will be prompted or use -h flag
                              Optional: --base-profile to use existing profile as template
                              Interactively prompts for basic configuration
  check-dependencies          Check if all required and optional dependencies are installed
  run                         Start a profile session (setup keybinds, launch tools)
  destroy                     End the current session (cleanup, unbind keys)
  delete-old-worlds           Delete old Minecraft worlds based on criteria
  run-jar <name> [args]       Download and run a JAR file from repositories.json
  setup-audio-splitter <enable|disable> [device]
                              Enable/disable PipeWire audio splitting
                              Optional: specify audio device name
  update                      Update all configured JAR files
  version                     Show version information

Options:
  -h HYPRMCSR_PROFILE         Set the hyprmcsr profile name
  -p PROFILE                  Set the PROFILE environment variable
  --help                      Show this help message
  --version                   Show version information

Examples:
  hyprmcsr check-dependencies # Check if all dependencies are installed
  hyprmcsr init               # Create profile interactively
  hyprmcsr -h ranked init     # Create 'ranked' profile interactively
  hyprmcsr init --base-profile default
                              # Create new profile based on 'default' profile
  hyprmcsr run                # Start default profile
  hyprmcsr -h ranked run      # Start 'ranked' profile
  hyprmcsr run-jar Ninjabrain-Bot
  hyprmcsr setup-audio-splitter enable
  hyprmcsr setup-audio-splitter enable "My Audio Device"
  hyprmcsr destroy            # End current session

For more documentation, see: https://github.com/Relacibo/hyprmcsr
EOF
  exit 1
}

# Show help if --help
if [[ "$1" == "--help" || "$1" == "help" ]]; then
  usage
fi

# Print version if --version or version command
if [[ "$1" == "--version" || "$1" == "version" ]]; then
  VERSION_FILE="$(dirname "$(realpath "$0")")/../VERSION"
  version_str=""
  if [ -f "$VERSION_FILE" ]; then
    version_str="$(cat "$VERSION_FILE")"
  else
    version_str="unknown version"
  fi

  # Show git commit if possible (full hash appended to version)
  GIT_DIR="$(dirname "$(realpath "$0")")/.."
  if [ -d "$GIT_DIR/.git" ]; then
    head_file="$GIT_DIR/.git/HEAD"
    if [ -f "$head_file" ]; then
      ref=$(cat "$head_file")
      if [[ "$ref" == ref:\ * ]]; then
        ref_file="$GIT_DIR/.git/$(echo "$ref" | cut -d' ' -f2)"
        if [ -f "$ref_file" ]; then
          commit=$(cat "$ref_file" | head -c 40)
          echo "$version_str"
          echo "git commit: $commit"
        else
          echo "$version_str"
        fi
      else
        # detached HEAD
        commit=$(echo "$ref" | head -c 40)
        echo "$version_str"
        echo "git commit: $commit"
      fi
    else
      echo "$version_str"
    fi
  else
    echo "$version_str"
  fi
  exit 0
fi

# Parse arguments
while [[ "$1" =~ ^- ]]; do
  case "$1" in
    -h)
      shift
      HYPRMCSR_PROFILE="$1"
      ;;
    -p)
      shift
      PROFILE="$1"
      ;;
    *)
      usage
      ;;
  esac
  shift
done

CMD="$1"
shift

if [ -z "$CMD" ]; then
  usage
fi

# Map kebab-case to script name
SCRIPT_NAME=$(echo "$CMD" | tr '-' '_').sh

# Directory where the actual scripts are located
SCRIPT_DIR=$(realpath "$(dirname "$(realpath "$0")")/../scripts")

SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_NAME"

# Security: Only allow execution of scripts in the scripts directory
if [[ ! "$SCRIPT_PATH" -ef "$SCRIPT_DIR/$(basename "$SCRIPT_PATH")" ]]; then
  echo "Refusing to execute script outside of scripts directory: $SCRIPT_PATH"
  exit 1
fi

if [ ! -f "$SCRIPT_PATH" ]; then
  echo "Unknown command: $CMD"
  usage
fi

# Set environment variables if specified
[ -n "$HYPRMCSR_PROFILE" ] && export HYPRMCSR_PROFILE="$HYPRMCSR_PROFILE"
[ -n "$PROFILE" ] && export PROFILE="$PROFILE"

exec "$SCRIPT_PATH" "$@"
